# Skill: Auto Orchestrator

ClaudeCode のサブエージェントをコーダー役、Codex を観点別レビュワー役に割り当て、要件定義→テスト→実装→レビュー→修正を自動反復するための運用スキル。

## 目的
- 人手のチャット転送をゼロにし、1機能あたりの開発〜レビューを全自動で収束させる。
- 安全・性能・整合性など観点別レビュワーを並列投入して品質を底上げする。

## 前提
- ChatGPT Pro (Codex CLI) と Claude MAX をサブスク内で使用（API課金なし）。
- Rust-first 開発ポリシー v2 を遵守。Hydra worktree を使用し main 直編集禁止。
- 品質ゲート Level A/B/C の段階適用ルールを有効化。

## インプット
- `.agent/plans_*.md` または `.agent/plan_*.md` にあるフェーズ定義（少なくとも Phase1=テスト, Phase2=実装）。
- コード差分（git diff）と実行ログ。
- 観点別プロンプト（安全/性能/整合）ひな型。

## アウトプット
- 観点別レビューレポート（指摘一覧、重大度タグ付き）。
- 修正後の差分とテスト結果。
- ゲート判定結果（Level A/B/C いずれか）と通過/失敗ログ。

## 運用ステップ（半自動→全自動化を想定）
1. **プラン読込**: プランファイルからフェーズ一覧を抽出。未定義なら Phase1=テスト, Phase2=実装を既定。
2. **Coder起動**: ClaudeCode に対象フェーズのタスクを投入。出力に diff/ログ/メモを含める指示を与える。
3. **Reviewer起動（並列）**: Codex (xhigh) を3役で起動  
   - Safety: 入力検証・権限・エラー設計  
   - Performance: p95/p99, メモリ, ロック/コピー  
   - Consistency: 仕様整合・可読性・所有権/ライフタイム
4. **指摘収束**: 各レビュワーの指摘を Coder に一括で戻し、修正→再レビューを自動反復。重大/高は必ず解消、中はスプリント内、低は backlog 登録。
5. **品質ゲート判定**: 変更規模から Level A/B/C を自動選択し、必要な `fmt/clippy/audit/テスト/ベンチ` を実行。失敗時は再度 Coder に戻す。
6. **昇格手順**: ステージング→カナリア→本番の順にデプロイ計画を生成し、p95・メモリ・エラー率を 24h 監視するチェックリストを自動生成。
7. **記録と通知**: 差分・指摘ログ・ゲート結果をまとめ、Slack 等に通知。docs/release-notes と docs/incidents（必要時）に自動追記。

## ClaudeCode→Codex 呼び出しレシピ（CLIのみ）
1. Coder (ClaudeCode) に「差分・ログを Markdown で出力し、末尾に `---OUTPUT-END---` を付ける」指示を含める。出力を `./.claude/tmp/<task>/<phase>_coder.md` に保存。  
2. Reviewer 実行: 安全/性能/整合の各プロンプトと Coder 出力を結合し、`codex exec -c model_reasoning_effort=xhigh --stdin` にパイプ。結果を `..._review_{safety|perf|consistency}.md` に保存。  
3. 指摘が残る限り、`reviews.md` を Coder に再投入し修正→再レビューを自動反復。  
4. ブロッカーがなくなれば品質ゲートへ進む。

## プロンプト雛形（Reviewer）
- Safety: 「入力検証・権限・エラー/例外・データ破損リスクを優先。重大度(High/Med/Low)付きで指摘し、再現手順と修正方針を短く提示。」
- Performance: 「p95/p99, メモリ常駐/ピーク, ロック/コピー/アロケーションを点検。ボトルネック候補と改善案を箇条書きで。」
- Consistency: 「仕様整合・可読性・所有権/ライフタイム・抽象化過剰の有無を確認。テスト不足も指摘。」

## ガードレール
- テスト基準を下げる変更は禁止。回避不能な場合は理由とリスクを明記し、承認を得る。
- Rust-first 例外を使うときは例外テンプレ（期間・理由・安全策・切り戻し）を添付。
- 重大指摘が残る状態で次フェーズへ進まない。

## 成功条件
- 人手でのチャットコピペ回数 0。
- 重大/高指摘が全解消し、ゲート Level B 以上を通過。
- p95/p99・メモリ・エラー率メトリクスを記録し、閾値内でリリース判定が下せる。
